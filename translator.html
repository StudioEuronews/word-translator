<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Multilingual Translator Word</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
        }

        .content {
            padding: 30px;
        }

        .language-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 25px;
        }

        .language-option {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .language-option:hover {
            background-color: #f5f5f5;
        }

        .language-option input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .language-option label {
            cursor: pointer;
            font-size: 0.9em;
            user-select: none;
        }

        .controls {
            margin-bottom: 25px;
        }

        .option-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .option-group h3 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #555;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-option input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.1);
        }

        .checkbox-option label {
            cursor: pointer;
            font-size: 0.9em;
        }

        .translate-btn {
            width: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .translate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .translate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .flag {
            margin-right: 5px;
            font-size: 1.1em;
            display: none;
        }

        .api-config {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: 500;
            color: #555;
        }

        .input-group input[type="password"],
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e1e1;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .input-group input[type="password"]:focus,
        .input-group select:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .api-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            display: none;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Multilingual Translator</h1>
        </div>
        
        <div class="content">
            <div class="language-grid">
                <div class="language-option">
                    <input type="checkbox" id="fr" value="fr" checked>
                    <label for="fr">French</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="de" value="de" checked>
                    <label for="de">German</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="it" value="it" checked>
                    <label for="it">Italian</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="es" value="es" checked>
                    <label for="es">Spanish</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="pt" value="pt" checked>
                    <label for="pt">Portuguese</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="ru" value="ru" checked>
                    <label for="ru">Russian</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="el" value="el" checked>
                    <label for="el">Greek</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="hu" value="hu" checked>
                    <label for="hu">Hungarian</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="pl" value="pl" checked>
                    <label for="pl">Polish</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="fa" value="fa" checked>
                    <label for="fa">Farsi</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="ar" value="ar">
                    <label for="ar">Arabic</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="tr" value="tr">
                    <label for="tr">Turkish</label>
                </div>
            </div>

            <div class="controls">
                <div class="option-group">
                    <h3>Azure Translator (Optional)</h3>
                    <div class="api-config">
                        <div class="input-group">
                            <label for="azureApiKey">API Key:</label>
                            <input type="password" id="azureApiKey" placeholder="Enter your Azure API key (optional)" />
                        </div>
                        <div class="input-group">
                            <label for="azureRegion">Region:</label>
                            <select id="azureRegion">
                                <option value="westeurope">West Europe</option>
                                <option value="eastus">East US</option>
                                <option value="westus2">West US 2</option>
                                <option value="southeastasia">Southeast Asia</option>
                                <option value="northeurope">North Europe</option>
                                <option value="centralus">Central US</option>
                            </select>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="saveApiKey">
                            <label for="saveApiKey">Remember my API key (stored locally)</label>
                        </div>
                        <div class="api-status" id="apiStatus"></div>
                    </div>
                </div>
                
                <div class="option-group">
                    <h3>Translation Options</h3>
                    <div class="checkbox-option">
                        <input type="checkbox" id="preserveFormat" checked>
                        <label for="preserveFormat">Preserve layout</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" id="redText" checked>
                        <label for="redText">Translated text in red</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" id="newPage" checked>
                        <label for="newPage">New page per language</label>
                    </div>
                </div>
            </div>

            <button class="translate-btn" onclick="startTranslation()">
                üöÄ Start Translation
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText"></div>
            </div>

            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        // Languages with ISO 639-1 codes
        const languages = {
            'fr': { name: 'French' },
            'de': { name: 'German' },
            'it': { name: 'Italian' },
            'es': { name: 'Spanish' },
            'pt': { name: 'Portuguese' },
            'ru': { name: 'Russian' },
            'el': { name: 'Greek' },
            'hu': { name: 'Hungarian' },
            'pl': { name: 'Polish' },
            'fa': { name: 'Farsi' },
            'ar': { name: 'Arabic' },
            'tr': { name: 'Turkish' }
        };

        // Euronews URL mapping
        const euronewsUrls = {
            'en': 'euronews.com',
            'fr': 'euronews.fr',
            'de': 'euronews.de',
            'it': 'euronews.it',
            'es': 'euronews.es',
            'pt': 'euronews.pt',
            'ru': 'ru.euronews.com',
            'hu': 'euronews.hu',
            'el': 'gr.euronews.com',
            'pl': 'pl.euronews.com',
            'ar': 'arabic.euronews.com',
            'fa': 'parsi.euronews.com',
            'tr': 'tr.euronews.com'
        };

        // Clean text by removing EN line and adapting URLs
        function processTextForTranslation(text, targetLang) {
            // Remove standalone "EN" line at the beginning
            let processedText = text.replace(/^EN\s*\n?/m, '').trim();
            
            // Replace any euronews URL (with or without subdomain) with language-specific version
            if (euronewsUrls[targetLang]) {
                // Match any euronews URL pattern (with or without subdomain)
                processedText = processedText.replace(/(?:https?:\/\/)?(?:[a-z]+\.)?euronews\.com/g, euronewsUrls[targetLang]);
            }
            
            return processedText;
        }

        // Apply URL adaptation to translated text
        function adaptEuronewsUrls(text, targetLang) {
            if (euronewsUrls[targetLang]) {
                // Replace any euronews URL pattern in translated text
                return text.replace(/(?:https?:\/\/)?(?:[a-z]+\.)?euronews\.com/g, euronewsUrls[targetLang]);
            }
            return text;
        }

        // Initialize Office
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                console.log('Add-in loaded in Word');
                loadSavedApiKey();
            }
        });

        // Load saved API key from localStorage
        function loadSavedApiKey() {
            try {
                const savedKey = localStorage.getItem('azureApiKey');
                const savedRegion = localStorage.getItem('azureRegion');
                const saveKeyEnabled = localStorage.getItem('saveApiKey') === 'true';
                
                if (savedKey && saveKeyEnabled) {
                    document.getElementById('azureApiKey').value = savedKey;
                    document.getElementById('saveApiKey').checked = true;
                    showApiStatus('üîë API key loaded from saved settings', 'info');
                }
                
                if (savedRegion) {
                    document.getElementById('azureRegion').value = savedRegion;
                }
            } catch (error) {
                console.log('Could not load saved settings');
            }
        }

        // Save API key if user wants to remember it
        function saveApiKeyIfNeeded() {
            const apiKey = document.getElementById('azureApiKey').value.trim();
            const region = document.getElementById('azureRegion').value;
            const shouldSave = document.getElementById('saveApiKey').checked;
            
            try {
                if (shouldSave && apiKey) {
                    localStorage.setItem('azureApiKey', apiKey);
                    localStorage.setItem('azureRegion', region);
                    localStorage.setItem('saveApiKey', 'true');
                } else {
                    localStorage.removeItem('azureApiKey');
                    localStorage.removeItem('azureRegion');
                    localStorage.removeItem('saveApiKey');
                }
            } catch (error) {
                console.log('Could not save settings');
            }
        }

        function showApiStatus(message, type) {
            const status = document.getElementById('apiStatus');
            status.textContent = message;
            status.className = `api-status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        async function startTranslation() {
            const selectedLanguages = getSelectedLanguages();
            
            if (selectedLanguages.length === 0) {
                showStatus('Please select at least one language.', 'error');
                return;
            }

            // Save API key settings
            saveApiKeyIfNeeded();

            const button = document.querySelector('.translate-btn');
            button.disabled = true;
            button.textContent = '‚è≥ Translation in progress...';

            showProgress(true);

            try {
                await Word.run(async (context) => {
                    // Get document content
                    const body = context.document.body;
                    body.load("text,style");
                    await context.sync();

                    const originalText = body.text;
                    
                    if (!originalText.trim()) {
                        throw new Error('The document is empty.');
                    }

                    // Translate for each selected language
                    for (let i = 0; i < selectedLanguages.length; i++) {
                        const langCode = selectedLanguages[i];
                        const langName = languages[langCode].name;
                        
                        updateProgress((i / selectedLanguages.length) * 100, `Translating to ${langName}...`);
                        
                        try {
                            // Process text: remove EN line and adapt URLs
                            const processedText = processTextForTranslation(originalText, langCode);
                            
                            const translatedText = await translateText(processedText, langCode);
                            await insertTranslation(context, translatedText, langName, langCode);
                        } catch (error) {
                            console.error(`Error translating to ${langName}:`, error);
                            await insertTranslation(context, `[Translation error for ${langName}]`, langName, langCode);
                        }
                    }

                    await context.sync();
                    updateProgress(100, 'Translation completed!');
                    
                    setTimeout(() => {
                        showProgress(false);
                        showStatus('Translation successful! The document has been updated.', 'success');
                    }, 1000);
                });

            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
                showProgress(false);
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Start Translation';
            }
        }

        async function insertTranslation(context, translatedText, langName, langCode) {
            const preserveFormat = document.getElementById('preserveFormat').checked;
            const redText = document.getElementById('redText').checked;
            const newPage = document.getElementById('newPage').checked;

            // Insert page break if requested
            if (newPage) {
                context.document.body.insertBreak(Word.BreakType.page, Word.InsertLocation.end);
            }

            // Insert language title
            const titleRange = context.document.body.insertText(`\n\n=== ${langName.toUpperCase()} ===\n\n`, Word.InsertLocation.end);
            titleRange.font.bold = true;
            titleRange.font.size = 16;
            titleRange.font.color = '#2196F3';

            // Insert translated text
            const textRange = context.document.body.insertText(translatedText, Word.InsertLocation.end);
            
            if (redText) {
                textRange.font.color = '#FF0000';
            }

            // Apply formatting if requested
            if (preserveFormat) {
                textRange.font.size = 12;
                // Skip paragraphFormat.spaceAfter as it's not always available in Word Online
            }

            await context.sync();
        }

        async function translateText(text, targetLang) {
            // Get user's API configuration
            const userApiKey = document.getElementById('azureApiKey').value.trim();
            const userRegion = document.getElementById('azureRegion').value;
            
            // Limit text length to prevent excessive costs
            const MAX_CHARACTERS = 5000;
            if (text.length > MAX_CHARACTERS) {
                console.warn(`‚ö†Ô∏è Text too long (${text.length} chars). Truncating to ${MAX_CHARACTERS} chars.`);
                text = text.substring(0, MAX_CHARACTERS) + '...';
            }
            
            try {
                // Try Azure Translator if user provided API key
                if (userApiKey && userApiKey !== '') {
                    console.log('üîµ Trying Azure Translator with user key...');
                    
                    const response = await fetch(`https://api.cognitive.microsofttranslator.com/translate?api-version=3.0&to=${targetLang}`, {
                        method: 'POST',
                        headers: {
                            'Ocp-Apim-Subscription-Key': userApiKey,
                            'Ocp-Apim-Subscription-Region': userRegion,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify([{text: text}])
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result && result[0] && result[0].translations && result[0].translations[0]) {
                            console.log('‚úÖ Azure Translator success');
                            showApiStatus('‚úÖ Azure Translator working perfectly!', 'success');
                            
                            // Apply Euronews URL adaptation to Azure translated text
                            const translatedText = adaptEuronewsUrls(result[0].translations[0].text, targetLang);
                            return translatedText;
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Azure Translator error:', response.status, response.statusText);
                        if (response.status === 401) {
                            showApiStatus('‚ùå Invalid API key or region. Check your Azure credentials.', 'error');
                        } else if (response.status === 403) {
                            showApiStatus('‚ùå API quota exceeded or access denied.', 'error');
                        } else {
                            showApiStatus(`‚ùå Azure error: ${response.status}`, 'error');
                        }
                    }
                } else {
                    console.log('‚ÑπÔ∏è No Azure API key provided, using free service');
                }
            } catch (error) {
                console.log('‚ùå Azure Translator failed:', error.message);
                if (userApiKey) {
                    showApiStatus('‚ùå Connection error to Azure Translator', 'error');
                }
            }
            
            try {
                // Fallback: MyMemory service (free)
                console.log('üü° Using MyMemory fallback service...');
                
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${targetLang}`);
                const data = await response.json();
                
                if (data.responseData && data.responseData.translatedText) {
                    console.log('‚úÖ MyMemory success');
                    if (!userApiKey) {
                        showApiStatus('‚ÑπÔ∏è Using free translation service. Add Azure key for better quality.', 'info');
                    }
                    
                    // Apply Euronews URL adaptation to translated text
                    const translatedText = adaptEuronewsUrls(data.responseData.translatedText, targetLang);
                    return translatedText;
                } else {
                    throw new Error('MyMemory service unavailable');
                }
            } catch (error) {
                console.log('‚ùå MyMemory failed:', error.message);
            }
            
            // Last resort: simulated text
            console.log('üî¥ Using fallback text simulation');
            return `[${languages[targetLang].name} Translation] ${text}`;
        }

        function getSelectedLanguages() {
            const checkboxes = document.querySelectorAll('.language-option input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function showProgress(show) {
            const container = document.getElementById('progressContainer');
            container.style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
